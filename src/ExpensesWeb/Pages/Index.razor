@page "/"
@using System.ComponentModel.DataAnnotations
@inject HttpClient Http
@inject IJSRuntime JS
@inject NavigationManager Nav

<div class="d-flex justify-content-between align-items-center mt-3 mb-3">
    <h3 class="m-0">Expenses</h3>

    <button class="btn btn-outline-danger" @onclick="Logout">
        Logout
    </button>
</div>

<div class="card p-3 mb-3 shadow-sm">
    <h5>Filters</h5>
    <div class="row g-2">
        <div class="col">
            <input class="form-control" placeholder="Category" @bind="filterCategory" />
        </div>
        <div class="col">
            <input type="date" class="form-control" @bind="filterFrom" />
        </div>
        <div class="col">
            <input type="date" class="form-control" @bind="filterTo" />
        </div>
        <div class="col-auto">
            <button class="btn btn-primary" @onclick="ApplyFilters">
                Apply
            </button>
        </div>
    </div>
</div>

@if (!isLoaded)
{
    <p>Loading...</p>
}
else
{
    @if (expenses == null || expenses.Count == 0)
    {
        <p>No expenses found.</p>
    }
    else
    {
        <table class="table table-striped table-bordered">
            <thead class="table-dark">
                <tr>
                    <th>Title</th>
                    <th>Amount</th>
                    <th>Currency</th>
                    <th>Category</th>
                    <th>Date</th>
                    <th style="width:220px;">Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var e in expenses)
                {
                    <tr>
                        @if (editingId == e.Id)
                        {
                            <td colspan="6">
                                <EditForm Model="editModel" OnValidSubmit="SaveEdit">
                                    <DataAnnotationsValidator />
                                    <ValidationSummary />

                                    <div class="row g-2 align-items-end">
                                        <div class="col">
                                            <InputText class="form-control" @bind-Value="editModel.Title" />
                                            <ValidationMessage For="@(() => editModel.Title)" />
                                        </div>

                                        <div class="col">
                                            <InputNumber class="form-control" @bind-Value="editModel.Amount" />
                                            <ValidationMessage For="@(() => editModel.Amount)" />
                                        </div>

                                        <div class="col">
                                            <InputText class="form-control" @bind-Value="editModel.Currency" />
                                            <ValidationMessage For="@(() => editModel.Currency)" />
                                        </div>

                                        <div class="col">
                                            <InputText class="form-control" @bind-Value="editModel.Category" />
                                            <ValidationMessage For="@(() => editModel.Category)" />
                                        </div>

                                        <div class="col">
                                            <InputDate class="form-control" @bind-Value="editModel.OccurredOn" />
                                            <ValidationMessage For="@(() => editModel.OccurredOn)" />
                                        </div>

                                        <div class="col-auto">
                                            <button type="submit" class="btn btn-success btn-sm me-2">
                                                Save
                                            </button>
                                            <button type="button" class="btn btn-secondary btn-sm" @onclick="CancelEdit">
                                                Cancel
                                            </button>
                                        </div>
                                    </div>
                                </EditForm>
                            </td>
                        }
                        else
                        {
                            <td>@e.Title</td>
                            <td>@e.Amount</td>
                            <td>@e.Currency</td>
                            <td>@e.Category</td>
                            <td>@e.OccurredOn.ToShortDateString()</td>
                            <td>
                                <button class="btn btn-warning btn-sm me-2" @onclick="() => StartEdit(e)">
                                    Edit
                                </button>
                                <button class="btn btn-danger btn-sm" @onclick="() => DeleteExpense(e.Id)">
                                    Delete
                                </button>
                            </td>
                        }
                    </tr>
                }
            </tbody>
        </table>

        <div class="d-flex justify-content-between align-items-center">
            <button class="btn btn-secondary" disabled="@(page <= 1)" @onclick="PreviousPage">
                Previous
            </button>

            <span>
                Page @(page) of @(totalPages)
            </span>

            <button class="btn btn-secondary" disabled="@(page >= totalPages)" @onclick="NextPage">
                Next
            </button>
        </div>
    }
}

<hr />

<h4>Create Expense</h4>

<EditForm Model="newExpense" OnValidSubmit="CreateExpense">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="mb-3">
        <label>Title</label>
        <InputText class="form-control" @bind-Value="newExpense.Title" />
        <ValidationMessage For="@(() => newExpense.Title)" />
    </div>

    <div class="mb-3">
        <label>Amount</label>
        <InputNumber class="form-control" @bind-Value="newExpense.Amount" />
        <ValidationMessage For="@(() => newExpense.Amount)" />
    </div>

    <div class="mb-3">
        <label>Currency</label>
        <InputText class="form-control" @bind-Value="newExpense.Currency" />
        <ValidationMessage For="@(() => newExpense.Currency)" />
    </div>

    <div class="mb-3">
        <label>Category</label>
        <InputText class="form-control" @bind-Value="newExpense.Category" />
        <ValidationMessage For="@(() => newExpense.Category)" />
    </div>

    <div class="mb-3">
        <label>Date</label>
        <InputDate class="form-control" @bind-Value="newExpense.OccurredOn" />
        <ValidationMessage For="@(() => newExpense.OccurredOn)" />
    </div>

    <button type="submit" class="btn btn-primary">
        Create
    </button>
</EditForm>

@code {

    private List<Expense>? expenses;
    private Expense newExpense = new();
    private Expense editModel = new();
    private int? editingId = null;

    private bool isLoaded = false;

    private int page = 1;
    private int pageSize = 5;
    private int totalCount;
    private int totalPages => (int)Math.Ceiling((double)totalCount / pageSize);

    private string? filterCategory;
    private DateTime? filterFrom;
    private DateTime? filterTo;

    protected override async Task OnInitializedAsync()
    {
        var token = await JS.InvokeAsync<string>("localStorage.getItem", "authToken");

        if (string.IsNullOrEmpty(token))
        {
            Nav.NavigateTo("/login", true);
            return;
        }

        Http.DefaultRequestHeaders.Authorization =
        new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);

        await LoadExpenses();
    }

    private async Task LoadExpenses()
    {
        var url = $"api/expenses?page={page}&pageSize={pageSize}";

        if (!string.IsNullOrEmpty(filterCategory))
            url += $"&category={filterCategory}";

        if (filterFrom.HasValue)
            url += $"&from={filterFrom:yyyy-MM-dd}";

        if (filterTo.HasValue)
            url += $"&to={filterTo:yyyy-MM-dd}";

        var response = await Http.GetFromJsonAsync<PagedResponse<Expense>>(url);

        expenses = response?.Items ?? new();
        totalCount = response?.TotalCount ?? 0;

        isLoaded = true;
    }

    private async Task ApplyFilters()
    {
        page = 1;
        await LoadExpenses();
    }

    private async Task NextPage()
    {
        if (page < totalPages)
        {
            page++;
            await LoadExpenses();
        }
    }

    private async Task PreviousPage()
    {
        if (page > 1)
        {
            page--;
            await LoadExpenses();
        }
    }

    private async Task CreateExpense()
    {
        var response = await Http.PostAsJsonAsync("api/expenses", newExpense);

        if (response.IsSuccessStatusCode)
        {
            newExpense = new Expense();
            await LoadExpenses();
        }
    }

    private void StartEdit(Expense e)
    {
        editingId = e.Id;
        editModel = new Expense
        {
            Id = e.Id,
            Title = e.Title,
            Amount = e.Amount,
            Currency = e.Currency,
            Category = e.Category,
            OccurredOn = e.OccurredOn
        };
    }

    private async Task SaveEdit()
    {
        await Http.PutAsJsonAsync($"api/expenses/{editModel.Id}", editModel);
        editingId = null;
        await LoadExpenses();
    }

    private void CancelEdit()
    {
        editingId = null;
    }

    private async Task DeleteExpense(int id)
    {
        await Http.DeleteAsync($"api/expenses/{id}");
        await LoadExpenses();
    }

    private async Task Logout()
    {
        await JS.InvokeVoidAsync("localStorage.removeItem", "authToken");
        Nav.NavigateTo("/login", true);
    }

    public class PagedResponse<T>
    {
        public int TotalCount { get; set; }
        public int Page { get; set; }
        public int PageSize { get; set; }
        public List<T> Items { get; set; } = new();
    }

    public class Expense
    {
        public int Id { get; set; }

        [Required(ErrorMessage = "Title is required.")]
        public string Title { get; set; } = "";

        [Range(0.01, double.MaxValue, ErrorMessage = "Amount must be greater than 0.")]
        public decimal Amount { get; set; }

        [Required(ErrorMessage = "Currency is required.")]
        [RegularExpression("EGP|USD|EUR", ErrorMessage = "Currency must be EGP, USD, or EUR.")]
        public string Currency { get; set; } = "";

        [Required(ErrorMessage = "Category is required.")]
        public string Category { get; set; } = "";

        [Required(ErrorMessage = "Date is required.")]
        public DateTime OccurredOn { get; set; } = DateTime.Today;
    }
}